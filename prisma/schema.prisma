generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "mongodb"
    url      = env("DATABASE_URL")
}

enum TipSource {
    ai
    manual
}

enum TipStatus {
    draft
    published
    failed
}

enum JobStatus {
    pending
    running
    completed
    failed
}

enum ActionType {
    like
    save
    share
}

model Tip {
    id           String    @id @default(auto()) @map("_id") @db.ObjectId
    tipText      String
    tipSummary   String?
    tipDetail    String?
    codeSnippet  String?
    category     String
    tags         String[]
    image        Json?
    viewMore     Json?
    source       TipSource @default(ai)
    status       TipStatus @default(draft)
    aiModel      String?
    costEstimate Int?
    jobId        String?   @db.ObjectId
    job          Job?      @relation(fields: [jobId], references: [id])
    likesCount   Int       @default(0)
    savesCount   Int       @default(0)
    sharesCount  Int       @default(0)
    viewsCount   Int       @default(0)
    createdAt    DateTime  @default(now())
    updatedAt    DateTime  @updatedAt
    actions      Action[]

    @@index([category])
    @@index([status])
    @@index([createdAt])
}

model Job {
    id         String    @id @default(auto()) @map("_id") @db.ObjectId
    startedAt  DateTime  @default(now())
    finishedAt DateTime?
    status     JobStatus @default(pending)
    summary    Json?
    errors     Json?
    tipsCount  Int       @default(0)
    tips       Tip[]
    createdAt  DateTime  @default(now())
    updatedAt  DateTime  @updatedAt
}

model User {
    id          String   @id @default(auto()) @map("_id") @db.ObjectId
    email       String   @unique
    name        String?
    avatar      String?
    provider    String?
    providerId  String?
    preferences Json?
    interests   String[]
    pushToken   String?
    deviceType  String?
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt
    actions     Action[]

    @@index([provider, providerId])
    @@index([pushToken])
}

model Action {
    id         String     @id @default(auto()) @map("_id") @db.ObjectId
    userId     String     @db.ObjectId
    user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
    tipId      String     @db.ObjectId
    tip        Tip        @relation(fields: [tipId], references: [id], onDelete: Cascade)
    actionType ActionType
    createdAt  DateTime   @default(now())

    @@unique([userId, tipId, actionType])
    @@index([userId])
    @@index([tipId])
}

// Track hourly push notifications to prevent duplicates
// Each hour slot (9am-12am = 15 slots) gets one tip notification per day
model DailyPush {
    id         String    @id @default(auto()) @map("_id") @db.ObjectId
    date       String // Format: YYYY-MM-DD, used for idempotency
    hour       Int // Hour of day (9-23), determines which tip to send
    tipId      String    @db.ObjectId
    tipCount   Int       @default(1) // How many tips were available when sent
    sentCount  Int       @default(0) // How many users received the push
    errorCount Int       @default(0) // How many failed
    status     String    @default("pending") // pending, sending, completed, failed
    startedAt  DateTime  @default(now())
    finishedAt DateTime?
    summary    Json?
    createdAt  DateTime  @default(now())
    updatedAt  DateTime  @updatedAt

    @@unique([date, hour]) // One push per hour per day
    @@index([tipId])
}
